<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Wedding Upload & Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    img, video {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .file-item {
      margin-bottom: 20px;
    }
    #gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    button, input[type="file"] {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
    }
    .pagination {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .pagination button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>üì∏ –ö–∞—á–µ—Ç–µ –≤–∞—à–∏—Ç–µ —Å–≤–∞—Ç–±–µ–Ω–∏ —Å–Ω–∏–º–∫–∏ –∏–ª–∏ –≤–∏–¥–µ–∞</h1>
  <input type="file" id="fileInput" multiple>–ò–∑–±–µ—Ä–∏ —Ñ–∞–π–ª–æ–≤–µ</input><br>
  <button onclick="upload()">–ö–∞—á–∏</button>
  <p id="status"></p>

  <h2>–ì–∞–ª–µ—Ä–∏—è:</h2>
  <div id="gallery"></div>
  <div class="pagination">
    <button onclick="prevPage()">–ü—Ä–µ–¥–∏—à–Ω–∞</button>
    <span id="pageNum">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
    <button onclick="nextPage()">–°–ª–µ–¥–≤–∞—â–∞</button>
  </div>

  <script>
    let uploaderName = "";
    const scriptURL = "https://script.google.com/macros/s/AKfycbxUXj0dRkue46V6ID84XEHNKB-Jt2mizJmA7l2YqihBygU1JEG_w_38-Yro66EUbjs3/exec";
    let files = [];
    let currentPage = 1;
    const filesPerPage = 40;

    function getUserName() {
      uploaderName = localStorage.getItem("uploaderName");
      if (!uploaderName) {
        uploaderName = prompt("–¢–≤–æ–µ—Ç–æ –∏–º–µ:");
        if (uploaderName) {
          uploaderName = uploaderName.trim();
          localStorage.setItem("uploaderName", uploaderName);
        } else {
          alert("–ò–º–µ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ.");
          getUserName();
        }
      }
    }

    async function upload() {
      const fileInput = document.getElementById("fileInput");
      const status = document.getElementById("status");

      if (!fileInput.files.length) {
        alert("–ú–æ–ª—è –∏–∑–±–µ—Ä–∏ —Ñ–∞–π–ª.");
        return;
      }

      status.textContent = "–ö–∞—á–≤–∞–Ω–µ...";
      for (const file of fileInput.files) {
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result.split(",")[1];
          const newName = `${uploaderName}_${Date.now()}_${file.name}`;

          const res = await fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify({
              name: newName,
              mimeType: file.type,
              base64: base64
            }),
            headers: { "Content-Type": "text/plain" }
          });

          const result = await res.text();
          console.log("Upload result:", result);
          loadGallery();
        };
        reader.readAsDataURL(file);
      }

      status.textContent = "–ö–∞—á–≤–∞–Ω–µ—Ç–æ —É—Å–ø–µ—à–Ω–æ.";
    }

    async function loadGallery() {
      const res = await fetch(`${scriptURL}?list=true`);
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∏—Ç–µ...";
      const allFiles = await res.json();

      files = allFiles.filter(f => f.name.startsWith(uploaderName + "_"));
      currentPage = 1;
      renderPage();
    }

    function renderPage() {
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      const start = (currentPage - 1) * filesPerPage;
      const end = start + filesPerPage;
      const pageFiles = files.slice(start, end);

      pageFiles.forEach(file => {
        const container = document.createElement("div");
        container.className = "file-item";

        if (file.mimeType.startsWith("image/")) {
          const img = document.createElement("img");
          img.src = file.url;
          img.alt = file.name;
          container.appendChild(img);
        } else if (file.mimeType.startsWith("video/")) {
          const video = document.createElement("video");
          video.src = file.url;
          video.controls = true;
          container.appendChild(video);
        } else {
          const link = document.createElement("a");
          link.href = file.url;
          link.textContent = file.name;
          link.target = "_blank";
          container.appendChild(link);
        }

        gallery.appendChild(container);
      });

      document.getElementById("pageNum").textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}`;
    }

    function nextPage() {
      if (currentPage * filesPerPage < files.length) {
        currentPage++;
        renderPage();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    }

    window.onload = () => {
      getUserName();
      loadGallery();
    };
  </script>
</body>
</html>
